#!/bin/bash

# Function to check if a command exists
command_exists() {
  command -v "$1" >/dev/null 2>&1
}

# Ensure storage permission for Termux
termux-setup-storage

# Function to install packages using the package manager
install_package() {
  local package_name=$1
  if ! command_exists "$package_name"; then
    echo "Installing $package_name..."
    pkg install -y "$package_name"
  else
    echo "$package_name is already installed."
  fi
}

# Update and upgrade Termux packages
echo "Updating package repositories..."
pkg update -y
echo "Upgrading installed packages..."
pkg upgrade -y

# Install necessary packages
install_package cronie  # Install cronie for cron job functionality
install_package termux-api  # Install termux-api for sending SMS
install_package whiptail  # Install whiptail for user interface

# Create necessary directories and set permissions
mkdir -p ~/.cache/crontab
mkdir -p ~/bin

# Download the sms script to ~/bin
echo "Downloading sms script..."
curl -s -o ~/bin/sms https://raw.githubusercontent.com/robertneed20k/auto-goodmorning/main/sms
chmod +x ~/bin/sms

# Ensure ~/bin is in PATH
if [[ ":$PATH:" != *":$HOME/bin:"* ]]; then
  echo 'export PATH="$HOME/bin:$PATH"' >> ~/.bashrc
  export PATH="$HOME/bin:$PATH"
fi

# Define sms alias in ~/.bashrc if not already defined
if ! grep -q "alias sms=" ~/.bashrc; then
  echo 'alias sms="$HOME/bin/sms"' >> ~/.bashrc
  source ~/.bashrc
fi

# Display completion message
echo "Installation complete! Run 'sms' to configure and start the SMS sender."
