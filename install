#!/bin/bash

# Function to check if a command exists
command_exists() {
  command -v "$1" >/dev/null 2>&1
}

# Ensure Termux is up-to-date
echo "Updating package repositories..."
pkg update -y

echo "Upgrading installed packages..."
pkg upgrade -y

# Function to install packages using the package manager
install_package() {
  local package_name=$1
  if ! command_exists "$package_name"; then
    echo "Installing $package_name..."
    pkg install -y "$package_name"
  fi
}

# Install necessary packages
install_package cronie  # Install cronie for cron job functionality
install_package termux-api  # Install termux-api for sending SMS
install_package whiptail  # Install whiptail for user interface

# Ensure directories exist before proceeding
mkdir -p ~/.cache/crontab
mkdir -p ~/bin

# Download send_sms.sh script to ~/bin/sms
curl -s -o ~/bin/send_sms.sh https://raw.githubusercontent.com/robertneed20k/auto-goodmorning/main/send_sms.sh
chmod +x ~/bin/send_sms.sh

# Ensure ~/bin is in PATH
if [[ ":$PATH:" != *":$HOME/bin:"* ]]; then
  echo 'export PATH="$HOME/bin:$PATH"' >> ~/.bashrc
  export PATH="$HOME/bin:$PATH"
fi

# Initial setup for sending SMS
sms() {
  echo "Setting up SMS sender..."
  ~/bin/send_sms.sh
}

# Add alias or function for 'sms' command
if ! grep -q "alias sms=" ~/.bashrc; then
  echo 'alias sms="~/bin/send_sms.sh"' >> ~/.bashrc
fi

# Remove previous commands from the terminal
clear

# Final setup message
echo "Installation complete! Run 'source ~/.bashrc' to refresh the shell."
echo "After refreshing, run 'sms' to configure and start the SMS sender."
